rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Función para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función para verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    // Función para verificar si el usuario es mesero
    function isMesero() {
      return isAuthenticated() && request.auth.token.role == 'mesero';
    }
    
    // Función para verificar si el usuario es cliente
    function isCliente() {
      return isAuthenticated() && request.auth.token.role == 'cliente';
    }
    
    // Función para verificar si es el propio usuario
    function isSelf(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Reglas para la colección Usuarios
    match /Usuarios/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin() || isSelf(userId);
      allow delete: if isAdmin();
      
      // Reglas para subcolecciones de Usuarios
      match /Historial/{historialId} {
        allow read: if isAdmin() || isSelf(userId);
        allow write: if isAdmin() || isMesero();
      }
    }
    
    // Reglas para la colección Beneficios
    match /Beneficios/{beneficioId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
      
      match /Seriales/{serialId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin() || isMesero();
      }
    }
    
    // Reglas para la colección Historial (global)
    match /Historial/{historialId} {
      allow read: if isAdmin();
      allow write: if isAdmin() || isMesero();
    }
    
    // Reglas para la colección BeneficioSeriales
    match /BeneficioSeriales/{serialId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isMesero();
      allow update: if isAdmin() || isMesero();
      allow delete: if isAdmin();
    }
    
    // Reglas para la colección Configuracion
    match /Configuracion/{configId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Reglas para la colección Notificaciones
    match /Notificaciones/{notifId} {
      allow read: if isAuthenticated() && (
        resource.data.recipientId == request.auth.uid || 
        resource.data.recipientId == 'all' ||
        isAdmin()
      );
      allow write: if isAdmin();
    }
  }
}
